{{ $src   := .Get "src"   | default "" }}
{{ $title := .Get "title" | default "" }}
{{ $class := .Get "class" | default "" }}
{{ $width := .Get "width" | default "auto"}}

{{ $src = urls.Parse $src }}
{{ if $src.Scheme }}
    {{ $src = $src.String }}
{{ else }}
    {{ $src = $src.Path }}
    {{ with (strings.TrimPrefix "/" $.Page.File.Dir) }}
        {{/* if not on "home" page: use path to file */}}
        {{ $src = printf "%s/%s" . $src }}
    {{ end }}
    {{ $src = $src | path.Clean | absURL }}

    {{ if $.Site.IsMultiLingual }}
        {{/*
            Hugo will include the current language code as subdir in the URL, but the
            additional content (images, files, ...) will be placed in the default
            language dir only. So the content will not be reachable using the correct
            URL generated by Hugo, and we have to use the URL pointing to the default
            language dir in all language variants.

            Replace the current language code in the path with the language code for the
            default language, e.g. replace "/ma/" w/ "/ba/" in "path/ma/images/wuppie.png"
            (result: "path/ba/images/wuppie.png").
        */}}
        {{ $default_lang := printf "/%s/" (index $.Site.Languages 0).Lang }}
        {{ $current_lang := printf "%s/" $.Site.LanguagePrefix }}
        {{ $src = replace $src $current_lang $default_lang }}
    {{ end }}
{{ end }}

{{/*
    Setting the width of the figure is just a workaround: It should be possible to set the
    width/height of an image using a style for the img tag. However, Hugo (or some of our
    configuration) seems to gobble this somehow and adds a 'style="width: auto; height: auto;"',
    which is not quite helpful.
*/}}
{{ with $src }}
<figure class="center" style="width:{{- $width -}}">
    <img alt="{{- $title -}}" src="{{- $src | safeURL -}}" class="{{- $class -}}" />
    {{ with $title }}<figcaption><h4>{{- $title -}}</h4></figcaption>{{ end }}
</figure>
{{ end }}
